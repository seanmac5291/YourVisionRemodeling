<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Schedule your free estimate online with Your Vision Roofing. Professional roofing and home improvement services in Northern Virginia, DC, and Maryland.">
    <title>Schedule Your Free Estimate | Your Vision Roofing</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- Header -->
    <header id="header" class="header" role="banner">
        <!-- Top Contact Bar -->
        <div class="top-bar">
            <div class="container">
                <div class="top-bar-content">
                    <div class="top-bar-left">
                        <div class="logo">
                            <a href="index.html">
                                <img src="Assets/Images/Final-logo.png" alt="Your Vision Roofing Logo" width="200" height="60">
                            </a>
                        </div>
                    </div>
                    <div class="top-bar-right">
                        <a href="tel:1-800-297-9878" class="top-contact">
                            <i class="fas fa-phone" aria-hidden="true"></i>
                            1-800-297-9878
                        </a>
                        <a href="index.html#contact" class="top-contact">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                            Email Us
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="main-nav" role="navigation" aria-label="Main navigation">
            <div class="container">
                <div class="nav-content">
                    <ul class="nav-menu" id="nav-menu" role="menubar">
                        <li role="none"><a href="roofing.html" role="menuitem">Roofing</a></li>
                        <li role="none"><a href="windows.html" role="menuitem">Windows</a></li>
                        <li role="none"><a href="gutters.html" role="menuitem">Gutters</a></li>
                        <li role="none"><a href="siding.html" role="menuitem">Siding</a></li>
                        <li role="none"><a href="painting.html" role="menuitem">Painting</a></li>
                        <li role="none"><a href="carpentry.html" role="menuitem">Carpentry</a></li>
                        <li role="none"><a href="interior-remodeling.html" role="menuitem">Interior Remodeling</a></li>
                        <li role="none"><a href="index.html#about" role="menuitem">About Us</a></li>
                        <li role="none"><a href="index.html#contact" role="menuitem">Contact Us</a></li>
                    </ul>

                    <!-- Mobile Menu Toggle -->
                    <button class="mobile-menu-toggle" id="mobile-menu-toggle" 
                            aria-controls="nav-menu" aria-expanded="false" aria-label="Toggle navigation menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Schedule Hero Section -->
        <section class="schedule-hero">
            <div class="hero-overlay"></div>
            <div class="schedule-hero-background"></div>
            <div class="container">
                <div class="schedule-hero-content">
                    <h1 class="schedule-hero-title">Schedule Your Free Estimate</h1>
                    <p class="schedule-hero-subtitle">Choose a convenient time below. Our professional team will provide a comprehensive assessment of your project needs.</p>
                </div>
            </div>
        </section>

        <!-- Calendly Section -->
        <section class="calendly-section">
            <div class="container-fluid">
                <div class="calendly-wrapper">
                    <!-- Customer Info Display -->
                    <div id="customer-info-display" class="customer-info-card" style="display: none;">
                        <div class="info-header">
                            <i class="fas fa-user-check"></i>
                            <h3>Your Information</h3>
                        </div>
                        <div class="info-content" id="customer-details"></div>
                        <button class="btn btn-outline edit-info-btn" onclick="editCustomerInfo()">
                            <i class="fas fa-edit"></i>
                            Edit Information
                        </button>
                    </div>

                    <!-- Calendly inline widget begin -->
                    <div class="calendly-inline-widget" id="calendly-widget" data-url="https://calendly.com/jj-yvrroofing/yvremodeling" style="min-width:320px;height:950px;"></div>
                    <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
                    <!-- Calendly inline widget end -->
                </div>
            </div>
        </section>

        <!-- Alternative Contact Section -->
        <section class="alternative-contact">
            <div class="container">
                <div class="alt-contact-content">
                    <h2>Prefer to Talk First?</h2>
                    <p>Not ready to schedule yet? We understand! Feel free to reach out with questions or fill out our contact form instead.</p>
                    <div class="alt-contact-buttons">
                        <a href="tel:1-800-297-9878" class="btn btn-primary">
                            <i class="fas fa-phone"></i>
                            Call Us Now
                        </a>
                        <a href="index.html#contact" class="btn btn-outline">
                            <i class="fas fa-envelope"></i>
                            Contact Form
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <div class="footer-logo">
                        <img src="Assets/Images/Final-logo-yellow.png" alt="Your Vision Roofing Logo" width="150" height="45">
                    </div>
                    <p class="footer-description">
                        Professional roofing and home improvement services in Northern Virginia, 
                        Washington DC, and Maryland since 2020.
                    </p>
                    <div class="social-links">
                        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>

                <div class="footer-column">
                    <h3 class="footer-title">Our Services</h3>
                    <ul class="footer-links">
                        <li><a href="roofing.html">Roofing</a></li>
                        <li><a href="windows.html">Windows</a></li>
                        <li><a href="gutters.html">Gutters</a></li>
                        <li><a href="siding.html">Siding</a></li>
                        <li><a href="painting.html">Painting</a></li>
                        <li><a href="carpentry.html">Carpentry</a></li>
                        <li><a href="interior-remodeling.html">Interior Remodeling</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h3 class="footer-title">Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="index.html#about">About Us</a></li>
                        <li><a href="index.html#contact">Contact Us</a></li>
                        <li><a href="index.html#testimonials">Testimonials</a></li>
                        <li><a href="tel:1-800-297-9878">Emergency Service</a></li>
                        <li><a href="schedule-estimate.html">Schedule Estimate</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h3 class="footer-title">Service Areas</h3>
                    <ul class="footer-links">
                        <li>Northern Virginia</li>
                        <li>Washington DC</li>
                        <li>Maryland</li>
                    </ul>
                    <div class="certifications">
                        <p><strong>Licensed & Insured</strong></p>
                        <p>VA: 2705180039</p>
                        <p>MHIC: 163621</p>
                        
                        <!-- Certification Logos -->
                        <div class="certification-logos">
                            <div class="logo-grid">
                                <div class="cert-logo-item">
                                    <img src="Assets/Images/logo5.png" alt="BBB Accredited Business" class="cert-logo">
                                </div>
                                <div class="cert-logo-item">
                                    <img src="Assets/Images/logo6.png" alt="Angi Certification" class="cert-logo">
                                </div>
                                <div class="cert-logo-item">
                                    <img src="Assets/Images/logo7.png" alt="Home Advisor Certification" class="cert-logo">
                                </div>
                                <div class="cert-logo-item">
                                    <img src="Assets/Images/gaf-logo-foo-1.png" alt="GAF Master Elite Contractor" class="cert-logo">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <p>&copy; 2024 Your Vision Roofing. All rights reserved.</p>
                    <p class="website-credit">Website designed & managed by <a href="#" target="_blank">YO MAMA</a></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/main.js"></script>
    
    <!-- Schedule Page Specific JavaScript -->
    <script>
        // ZAPIER WEBHOOK CONFIGURATION - Updated with actual webhook URL
        const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/24660064/umv86ib/';

        document.addEventListener('DOMContentLoaded', function() {
            initializeSchedulePage();
        });

        function initializeSchedulePage() {
            const customerData = JSON.parse(sessionStorage.getItem('customerData') || 'null');
            const customerId = sessionStorage.getItem('customerId');

            if (customerData && customerId) {
                displayCustomerInfo(customerData);
                updateCalendlyURL(customerData);
                
                // Set up Calendly event listener for booking confirmation
                setupCalendlyEventListener(customerId, customerData);
            } else {
                // Redirect back to homepage if no customer data found
                showNoDataMessage();
            }
        }

        // Set up Calendly booking event listener
        function setupCalendlyEventListener(customerId, customerData) {
            window.addEventListener('message', function(e) {
                // Listen for Calendly booking events
                if (e.data.event && e.data.event === 'calendly.event_scheduled') {
                    handleBookingConfirmation(customerId, customerData, e.data.payload);
                }
            });
        }

        // Handle booking confirmation
        async function handleBookingConfirmation(customerId, customerData, eventData) {
            console.log('Booking confirmed for customer:', customerId);
            
            // Mark booking as completed (prevents reminder email)
            localStorage.setItem(`booking_completed_${customerId}`, 'true');
            
            // Clean up reminder timeout if it exists
            const timeoutId = localStorage.getItem(`reminder_timeout_${customerId}`);
            if (timeoutId) {
                clearTimeout(parseInt(timeoutId));
                localStorage.removeItem(`reminder_timeout_${customerId}`);
            }
            
            // Send booking confirmation to Zapier
            const confirmationData = {
                ...customerData,
                intent: 'booking_confirmed',
                customerId: customerId,
                calendlyEvent: eventData,
                timestamp: new Date().toISOString(),
                source: 'calendly_booking_confirmation'
            };
            
            try {
                await sendToZapier(confirmationData);
                console.log('Booking confirmation sent to Zapier successfully');
                
                // Redirect to thank you page
                setTimeout(() => {
                    window.location.href = 'thank-you.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error sending booking confirmation to Zapier:', error);
                // Still redirect even if webhook fails
                setTimeout(() => {
                    window.location.href = 'thank-you.html';
                }, 1000);
            }
        }

        // Send data to Zapier webhook
        async function sendToZapier(data) {
            if (!ZAPIER_WEBHOOK_URL || ZAPIER_WEBHOOK_URL === 'REPLACE_WITH_YOUR_ZAPIER_WEBHOOK_URL') {
                console.warn('Zapier webhook URL not configured on schedule page');
                return;
            }
            
            try {
                // Convert JSON data to FormData to avoid CORS issues
                const formData = new FormData();
                Object.keys(data).forEach(key => {
                    formData.append(key, data[key]);
                });
                
                const response = await fetch(ZAPIER_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData // Remove Content-Type header - let browser set it
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                console.log('Data sent to Zapier from schedule page:', data.intent);
                return response;
            } catch (error) {
                console.error('Zapier webhook error on schedule page:', error);
                throw error;
            }
        }

        function displayCustomerInfo(data) {
            const infoDisplay = document.getElementById('customer-info-display');
            const detailsContainer = document.getElementById('customer-details');
            
            detailsContainer.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-value">${data.fullName || `${data.firstName || ''} ${data.lastName || ''}`.trim()}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${data.email || 'Not provided'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phone:</span>
                    <span class="info-value">${data.phone || 'Not provided'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Address:</span>
                    <span class="info-value">${data.fullAddress || 'Not provided'}</span>
                </div>
                ${data.message ? `
                <div class="info-row">
                    <span class="info-label">Project:</span>
                    <span class="info-value">${data.message}</span>
                </div>` : ''}
            `;
            
            infoDisplay.style.display = 'block';
        }

        function updateCalendlyURL(data) {
            const widget = document.getElementById('calendly-widget');
            const baseURL = 'https://calendly.com/jj-yvrroofing/yvremodeling';
            
            // Clean and format data before adding to URL
            const cleanText = (text) => {
                if (!text) return '';
                return text.toString().trim().replace(/\s+/g, ' '); // Remove extra whitespace
            };
            
            // Manual URL parameter building for better control over encoding
            const urlParams = [];
            
            // Add first name and last name separately if available
            if (data.firstName && data.firstName.trim()) {
                urlParams.push(`first_name=${encodeURIComponent(cleanText(data.firstName))}`);
            }
            if (data.lastName && data.lastName.trim()) {
                urlParams.push(`last_name=${encodeURIComponent(cleanText(data.lastName))}`);
            }
            
            // If no separate names but have fullName, try to split it
            if (!data.firstName && !data.lastName && data.fullName) {
                const fullName = cleanText(data.fullName);
                const nameParts = fullName.split(' ').filter(part => part.length > 0);
                if (nameParts.length > 0) {
                    urlParams.push(`first_name=${encodeURIComponent(nameParts[0])}`);
                }
                if (nameParts.length > 1) {
                    urlParams.push(`last_name=${encodeURIComponent(nameParts.slice(1).join(' '))}`);
                }
            }
            
            // Add other information with proper cleaning
            if (data.email && data.email.trim()) {
                urlParams.push(`email=${encodeURIComponent(cleanText(data.email))}`);
            }
            
            if (data.phone && data.phone.trim()) {
                // Clean phone number - format nicely
                let cleanPhone = data.phone.replace(/[^\d\s\-\(\)\+\.]/g, '').trim();
                // Format as (XXX) XXX-XXXX if it's a 10-digit US number
                const digits = cleanPhone.replace(/\D/g, '');
                if (digits.length === 10) {
                    cleanPhone = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
                }
                urlParams.push(`a1=${encodeURIComponent(cleanPhone)}`);
            }
            
            if (data.fullAddress && data.fullAddress.trim()) {
                // Clean address formatting
                const cleanAddress = cleanText(data.fullAddress);
                urlParams.push(`a2=${encodeURIComponent(cleanAddress)}`);
            }
            
            if (data.message && data.message.trim()) {
                urlParams.push(`a3=${encodeURIComponent(cleanText(data.message))}`);
            } else {
                urlParams.push(`a3=${encodeURIComponent('Estimate Request')}`);
            }
            
            // Build final URL
            const finalURL = urlParams.length > 0 ? `${baseURL}?${urlParams.join('&')}` : baseURL;
            widget.setAttribute('data-url', finalURL);
            
            // Debug log to check URL formatting
            console.log('Clean Calendly URL:', finalURL);
            console.log('URL Parameters:', urlParams);
            
            // Reinitialize Calendly with new URL
            if (window.Calendly) {
                window.Calendly.initInlineWidget({
                    url: finalURL,
                    parentElement: widget
                });
            } else {
                // Wait for Calendly script to load
                const checkCalendly = setInterval(() => {
                    if (window.Calendly) {
                        clearInterval(checkCalendly);
                        window.Calendly.initInlineWidget({
                            url: finalURL,
                            parentElement: widget
                        });
                    }
                }, 100);
            }
        }

        function editCustomerInfo() {
            if (confirm('This will take you back to the contact form to update your information. Continue?')) {
                // Clear stored data
                sessionStorage.removeItem('customerData');
                sessionStorage.removeItem('customerId');
                
                // Clear any booking completion markers
                const customerId = sessionStorage.getItem('customerId');
                if (customerId) {
                    localStorage.removeItem(`booking_completed_${customerId}`);
                }
                
                window.location.href = 'index.html#contact';
            }
        }

        function showNoDataMessage() {
            const calendlySection = document.querySelector('.calendly-section');
            calendlySection.innerHTML = `
                <div class="container">
                    <div class="no-data-message">
                        <div class="message-content">
                            <i class="fas fa-info-circle"></i>
                            <h3>Please Fill Out Contact Information First</h3>
                            <p>To schedule your estimate, we need some basic information about you and your project. Please fill out our contact form first.</p>
                            <div class="message-buttons">
                                <a href="index.html#contact" class="btn btn-primary">
                                    <i class="fas fa-arrow-left"></i>
                                    Go to Contact Form
                                </a>
                                <a href="tel:1-800-297-9878" class="btn btn-outline">
                                    <i class="fas fa-phone"></i>
                                    Call Instead
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>